From 35e530fe8bf6ee7b543b3f4b715d01540f27874c Mon Sep 17 00:00:00 2001
From: Zheng Ruoqin <zhengrq.fnst@cn.fujitsu.com>
Date: Thu, 26 Apr 2018 11:13:34 +0000
Subject: [PATCH] Modified the URL of dnf intead of upstream.

Signed-off-by: Zheng Ruoqin <zhengrq.fnst@cn.fujitsu.com>
---
 .../dnf/dnf/oe-remote-repo.repo.sample             |  5 ++++
 meta/recipes-devtools/dnf/dnf_2.6.3.bb             | 30 ++++++++++++++++------
 2 files changed, 27 insertions(+), 8 deletions(-)
 create mode 100644 meta/recipes-devtools/dnf/dnf/oe-remote-repo.repo.sample

diff --git a/meta/recipes-devtools/dnf/dnf/oe-remote-repo.repo.sample b/meta/recipes-devtools/dnf/dnf/oe-remote-repo.repo.sample
new file mode 100644
index 0000000..6c4502e
--- /dev/null
+++ b/meta/recipes-devtools/dnf/dnf/oe-remote-repo.repo.sample
@@ -0,0 +1,5 @@
+[base]
+name=myrepo
+baseurl=http://127.0.0.1/oe_repo/
+enabled=1
+gpgcheck=0
diff --git a/meta/recipes-devtools/dnf/dnf_2.6.3.bb b/meta/recipes-devtools/dnf/dnf_2.6.3.bb
index 3ed6a74..7c6c401 100644
--- a/meta/recipes-devtools/dnf/dnf_2.6.3.bb
+++ b/meta/recipes-devtools/dnf/dnf_2.6.3.bb
@@ -4,29 +4,30 @@ LIC_FILES_CHKSUM = "file://COPYING;md5=b234ee4d69f5fce4486a80fdaf4a4263 \
                     file://PACKAGE-LICENSING;md5=bfc29916e11321be06924c4fb096fdcc \
                    "
 
-SRC_URI = "git://github.com/rpm-software-management/dnf.git \
+SRC_URI = "git://github.com/ubinux/dnf.git;branch=dnf-yocto2.4 \
            file://0029-Do-not-set-PYTHON_INSTALL_DIR-by-running-python.patch \
-           file://0030-Run-python-scripts-using-env.patch \
-           file://0001-Do-not-prepend-installroot-to-logdir.patch \
-           file://0001-Do-not-hardcode-etc-and-systemd-unit-directories.patch \
-           file://0001-Corretly-install-tmpfiles.d-configuration.patch \
-           file://0001-Check-conf.releasever-instead-of-releasever.patch \
            "
 
-SRCREV = "be2585183ec4485ee4d5e121f242d8669296f065"
+SRC_URI_append_class-target = "file://oe-remote-repo.repo.sample"
+                             
+
+SRCREV = "bb4de0bba6caf442ba37af908713a4dee89be3b1"
 UPSTREAM_CHECK_GITTAGREGEX = "(?P<pver>\d+(\.\d+)+)"
 
 S = "${WORKDIR}/git"
 
 inherit cmake gettext bash-completion distutils3-base systemd
 
-DEPENDS += "libdnf librepo libcomps python3-iniparse"
+DEPENDS += "libdnf librepo libcomps python3-iniparse libnewt-python"
 
 # manpages generation requires http://www.sphinx-doc.org/
 EXTRA_OECMAKE = " -DWITH_MAN=0 -DPYTHON_INSTALL_DIR=${PYTHON_SITEPACKAGES_DIR} -DPYTHON_DESIRED=3"
 
 BBCLASSEXTEND = "native nativesdk"
 RDEPENDS_${PN}_class-target += "python3-core python3-codecs python3-netclient python3-email python3-threading python3-distutils librepo python3-shell python3-subprocess libcomps libdnf python3-sqlite3 python3-compression python3-rpm python3-iniparse python3-json python3-importlib python3-curses python3-argparse python3-misc python3-gpg"
+
+RDEPENDS_${PN}_class-nativesdk +=  "python3-core python3-codecs python3-netclient python3-email python3-threading python3-distutils librepo python3-shell python3-subprocess libcomps libdnf python3-sqlite3 python3-compression python3-rpm python3-iniparse python3-json python3-importlib python3-curses python3-argparse python3-misc python3-gpg gpgme update-rc.d "
+
 # Recommend gnupg so that GPG signature check on repository metadata is possible
 RRECOMMENDS_${PN}_class-target += "gnupg"
 
@@ -45,6 +46,19 @@ do_install_append_class-native() {
                 RPM_NO_CHROOT_FOR_SCRIPTS=1
 }
 
+do_install_append_class-nativesdk() {
+        create_wrapper ${D}/${bindir}/dnf \
+                RPM_CONFIGDIR=${SDKPATHNATIVE}${libdir_nativesdk}/rpm \
+                RPM_NO_CHROOT_FOR_SCRIPTS=1
+        install -m 0755 ${S}/environment-dnf.sh ${D}/${bindir}/environment-dnf.sh
+        install -m 0755 ${S}/dnf-host ${D}/${bindir}/dnf-host
+}
+
+do_install_append_class-target() {
+        install -d ${D}${sysconfdir}/yum.repos.d
+        install -m 0644 ${WORKDIR}/oe-remote-repo.repo.sample ${D}${sysconfdir}/yum.repos.d
+}
+
 SYSTEMD_SERVICE_${PN} = "dnf-makecache.service dnf-makecache.timer \
                          dnf-automatic-download.service dnf-automatic-download.timer \
                          dnf-automatic-install.service dnf-automatic-install.timer \
-- 
1.8.3.1

